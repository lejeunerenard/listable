/*! Listable v0.9.2 - 2014-03-12 
 *  Author: Sean Zellmer 
 *  License: MIT
 */

!function(a,b,c,d){var e=!1,f=!0;a.widget("ui.listable",a.ui.mouse,{options:{add:!0,add_after:!0,add_image:"/javascripts/listable/images/add.png",auto_build:!0,connectWith:"",controls:!0,"delete":!0,delete_confirmation:!1,delete_image:"/javascripts/listable/images/delete.png",depth:!1,deeper_image:"/javascripts/listable/images/right_arrow.png",edit:!0,edit_image:"/javascripts/listable/images/edit.png",fancybox_padding:null,field_dividers_enabled:!0,form_vault:"#listable-form-vault",gear_image:"",gear_transition:"fade",image_dragging:!0,initial_add:!0,max_depth:null,shallower_image:"/javascripts/listable/images/left_arrow.png",types:[],after_delete:null,after_save:null,before_delete:null,beforeDisplay:null,beforeSave:null,editOnComplete:null,field_divider_click:null,over:null,onTransfer:null,update:null},_create:function(){a.fn.listable.counter===d&&(a.fn.listable.counter=0),a.fn.listable.current_listable||(a.fn.listable.current_listable=this.element);var c=this.options,g=this;if(this.element.hasClass("listable")||this.element.addClass("listable"),c.variable_vault||(c.variable_vault=this.element.parents("form")),a.fn.listable.counter+=c.variable_vault.find('input[name="type[]"]').length+1,c.auto_build&&this.refresh(),c.controls){var h='<div class="listable-controls">';a.each(c.types,function(a,b){var c;c=b.button_name?b.button_name.toLowerCase().replace(/ /,"_"):b.type.toLowerCase().replace(/ /,"_"),h+='                  <a class="button listable-el-'+c+'" href="#'+b.formid+'">Add ',h+=b.button_name?b.button_name:b.type.charAt(0).toUpperCase()+b.type.slice(1),h+="</a>"}),h+='            <a class="close" href="#"></a>         </div>',a("body").append(h),a(".listable-controls .button").live("click",function(b){a(c.form_vault+" form").hide(),a(a(this).attr("href")).show();var d=a.extend({},{href:c.form_vault,onComplete:function(){a(a(this).attr("href")).find('input[type!="hidden"]').eq(0).focus()},onClosed:function(){a(".chosen-container").each(function(){a("#"+a(this).attr("id").replace(/_chosen/g,"")).trigger("chosen:updated")})}});c.fancybox_padding&&(d=a.extend(d,{padding:c.fancybox_padding})),a.fancybox(d),b.preventDefault()})}if(0==a(c.form_vault).find("#msg-listable").length&&a(c.form_vault).prepend('<div id="msg-listable"></div>'),c.image_dragging||this.element.find("img").live("dragstart",function(a){a.preventDefault()}),a(b).focus(function(){f=!0}),a("input, select").focus(function(){f=!1}),a("input, select").blur(function(){f=!0}),a("#app_folder_chosen").live("focus",function(){f=!1}),a("#app_folder_chosen").live("blur",function(){f=!0}),c.field_dividers_enabled){a(".field_divider").live("mouseover mouseout",function(b){"mouseover"==b.type?(a(this).stop(),a(this).fadeTo("slow",.5)):(a(this).stop(),a(this).fadeTo("slow",1))});var i=function(){c.controls&&(a(".listable-controls").show("fast"),a(".listable-controls").css("left",a(this).offset().left+parseInt(a(this).css("width"))+25),a(".listable-controls").css("top",a(this).offset().top+parseInt(a(this).css("height"))/2-25)),g.current_divider&&g.current_divider.attr("hil",""),g.current_divider=a(this),g.current_divider.attr("hil","highlighted"),a.fn.listable.current_listable=a(this).parent()};"function"==typeof c.field_divider_click&&(i=c.field_divider_click),a(".field_divider").live("click",i)}return c.controls&&a(".listable-controls .close").click(function(b){b.preventDefault(),a(".listable-controls").hide("fast")}),c.depth&&this.element.find(".field_depth").live("click",function(b){a(this).hasClass("shallower")?(update_class=a(this).attr("class").replace(/field_depth shallower /,""),depth=parseInt(c.variable_vault.find("input."+update_class+'[name="depth[]"]').val()),depth-=1,0>depth?depth=0:g.element.find(".form_field."+update_class).removeClass("depth_"+(depth+1)).addClass("depth_"+depth),a(c.variable_vault).find("input."+update_class+'[name="depth[]"]').val(depth)):(update_class=a(this).attr("class").replace(/field_depth deeper /,""),depth=parseInt(c.variable_vault.find("input."+update_class+'[name="depth[]"]').val()),depth+=1,c.max_depth?depth>c.max_depth?depth=c.max_depth:g.element.find(".form_field."+update_class).removeClass("depth_"+(depth-1)).addClass("depth_"+depth):g.element.find(".form_field."+update_class).removeClass("depth_"+(depth-1)).addClass("depth_"+depth),a(c.variable_vault).find("input."+update_class+'[name="depth[]"]').val(depth)),b.preventDefault()}),c.gear_image&&(this.element.find(".listable_item_buttons").hide(0),this.element.find(".listable_gear").live("click",function(b){b.preventDefault(),"slide"==c.gear_transition?a(this).siblings(".listable_item_buttons").slideToggle("fast"):a(this).siblings(".listable_item_buttons").fadeToggle("fast")})),c.delete&&this.element.find(".delete_field").live("click",function(b){if(c.delete_confirmation&&!confirm("Are you sure you want to delete this? (click 'Cancel' for 'no')"))return!1;"function"==typeof c.before_delete&&c.before_delete(this);var d=a(this).attr("class").replace(/delete_field field_/,"");g.element.find(".field_"+d).remove(),c.variable_vault.find(".field_"+d).remove(),b.preventDefault(),"function"==typeof c.after_delete&&c.after_delete(this)}),c.edit&&this.element.find(".edit_field").live("click",function(b){a.fn.listable.current_listable=g.element,edit_link=a(this),e=a(this).attr("class").replace(/edit_field /,""),a(c.form_vault+" form").hide();var d={};a.each(c.types,function(a,b){return b.type==c.variable_vault.find("input."+edit_link.attr("class").replace(/edit_field /,"")+'[name="type[]"]').val()?(d=b,!1):void 0}),a.each(d.variables,function(b,f){var h,i;if(i=d.prefix?d.prefix+"_":"",h=g._findInput({formId:d.formid,prefix:i,value:f}),"checkbox"==h.attr("type"))"1"==c.variable_vault.find("input."+e+'[name="'+f+'[]"]').val()?h.attr("checked","checked"):h.attr("checked","");else if(h.is("select")){ids=c.variable_vault.find("input."+e+'[name="'+f+'[]"]').val().split(",");for(var j=0;j<ids.length;j++)h.find('option[value="'+ids[j]+'"]').attr("selected","selected");a(".chosen-container").each(function(){a("#"+a(this).attr("id").replace(/_chosen/g,"")).trigger("chosen:updated")})}else h.val(c.variable_vault.find("input."+e+'[name="'+f+'[]"]').val())});var f;f=d.prefix?d.prefix+"_":"";var h=g._findInput({formId:d.formid,prefix:f,value:d.variables[0]});a("#"+d.formid).show();var i=a.extend({},{href:c.form_vault,onComplete:function(){h.focus(),a.isFunction(c.editOnComplete)&&c.editOnComplete(d.formid)},onClosed:function(){a("#"+d.formid)[0].reset(),a.each(d.variables,function(b,c){a("select#"+d.prefix+"_"+c).length>0&&(a("select#"+d.prefix+"_"+c).find("option").removeAttr("selected"),a(".chosen-container").each(function(){a("#"+a(this).attr("id").replace(/_chosen/g,"")).trigger("chosen:updated")}))}),e=!1}});c.fancybox_padding&&(i=a.extend(i,{padding:c.fancybox_padding})),a.fancybox(i),b.preventDefault()}),c.disabled||this.element.sortable({items:".form_field",cancel:".field_divider",connectWith:c.connectWith,placeholder:"place_holder",delay:"200",cursor:"crosshair",change:function(){c.field_dividers_enabled&&(g.element.find(".field_divider").remove(),g.element.find(".form_field, .place_holder").not(".ui-sortable-helper").each(function(){var b=a(this).attr("class").replace(/form_field /,"").replace(/ depth_\d/,"");a(this).hasClass("place_holder")&&g.element.find(".form_field.ui-sortable-helper").length>0&&(b=g.element.find(".form_field.ui-sortable-helper").attr("class").replace(/form_field /,"").replace(/ depth_\d/,"").replace(/ ui-sortable-helper/,"")),a(this).after('<li class="field_divider '+b+'">                                 <img src="'+c.add_image+'" alt="add field"/>                              </li>')}),g.element.find(".form_field, .place_holder").first().before('<li class="field_divider field_0">                                 <img src="'+c.add_image+'" alt="add field"/>                              </li>'))},over:function(a,b){"function"==typeof c.over&&c.over(a,b)},update:function(a,b){g.update_order(),b.sender&&(g.transfer(a,b),"function"==typeof c.onTransfer&&c.onTransfer(a,b)),"function"==typeof c.update&&c.update(a,b)}}),this},_findInput:function(b){var c,d=b.formId,e=b.prefix,f=b.value;return d&&(c="#"+d+" "),input_element=a(c+"#"+e+f).filter(":input").length>0?a(c+"#"+e+f).filter(":input"):a(c+'[name="'+e+f+'"]').filter(":input")},destroy:function(){a.Widget.prototype.destroy.call(this)},_setOption:function(b,c){switch(b){case"current_divider":this.current_divider=c;default:this.options[b]=c}a.Widget.prototype._setOption.apply(this,arguments)},save:function(b,c,d){var f=this.options,g=this,h={};return a.isFunction(c)?f.beforeSave=c:"undefined"!=typeof c&&(a.isFunction(c.beforeSave)&&(f.beforeSave=c.beforeSave),a.isFunction(c.after_save)&&(f.after_save=c.after_save),a.isFunction(c.beforeDisplay)&&(f.beforeDisplay=c.beforeDisplay),"undefined"!=typeof c.vars&&(h=c.vars)),a.isFunction(d)&&(f.after_save=d),a.isFunction(f.beforeSave)&&f.beforeSave(b,h),a.isEmptyObject(h)&&a.each(b.variables,function(a,c){var d,e;e=b.prefix?b.prefix+"_":"",d=g._findInput({formId:b.formid,prefix:e,value:c}),h[c]="checkbox"==d.attr("type")?d.attr("checked")?1:0:d.val()}),a.each(h,function(b,c){e?f.variable_vault.find("input."+e+'[name="'+b+'[]"]').val(c):a(f.variable_vault).append('<input type="hidden" name="'+b+'[]" value="'+c+'" class="field_'+a.fn.listable.counter+'" >')}),e||(f.add_after?a(f.variable_vault).append('<input type="hidden" name="order[]" value="'+(parseInt(a("."+g.current_divider.attr("class").replace(/field_divider /,"")+'[name="order[]"]').val())+1)+'" class="field_'+a.fn.listable.counter+'" >                    <input type="hidden" name="type[]" value="'+b.type+'" class="field_'+a.fn.listable.counter+'" >'):a(f.variable_vault).append('<input type="hidden" name="order[]" value="'+(parseInt(a("."+g.current_divider.attr("class").replace(/field_divider /,"")+'[name="order[]"]').val())-1)+'" class="field_'+a.fn.listable.counter+'" >                    <input type="hidden" name="type[]" value="'+b.type+'" class="field_'+a.fn.listable.counter+'" >'),g.current_divider.nextAll(".form_field").each(function(){a(f.variable_vault).find("input."+a(this).attr("class").replace(/form_field /,"").replace(/ depth_\d/,"")+"[name=order\\[\\]]").val(a(f.variable_vault).find("input."+a(this).attr("class").replace(/form_field /,"").replace(/ depth_\d/,"")+"[name=order\\[\\]]").val()+1)}),f.depth&&a(f.variable_vault).append('<input type="hidden" name="depth[]" value="0" class="field_'+a.fn.listable.counter+'" >'),a.fn.listable.counter++),this.refresh(),this.element.find(".form_field").each(function(b){f.variable_vault.find("input."+a(this).attr("class").replace(/form_field /,"").replace(/ depth_\d/,"")+"[name=order\\[\\]]").val(b)}),a.isFunction(f.after_save)&&f.after_save(b),a("#"+b.formid)[0].reset(),this.update_order(),this},refresh:function(){var b=this.options,c=this,d=new Object;a.each(b.types,function(){d[this.type]=this}),c.element.empty();var e;return c.current_divider&&(temp_current_divder=c.current_divider),c.current_divider=null,b.field_dividers_enabled&&c.element.append('          <li class="field_divider field_'+a.fn.listable.counter+'">        <img src="'+b.add_image+'" alt="add field" />          </li>'),c.current_divider&&c.current_divider.length||(c.current_divider=this.element.find(".field_divider").filter(":first")),c.current_divider.length||(c.element.empty(),b.initial_add&&b.add_after&&(c.element.append('             <li class="field_divider divide_0">              <img src="'+b.add_image+'" alt="add field" />             </li>'),c.current_divider=c.element.find(".field_divider").filter(":first"))),b.variable_vault.find('input[name="type[]"]').sort(function(c,d){return b.variable_vault.find("input."+a(d).attr("class")+'[name="order[]"]').val()-b.variable_vault.find("input."+a(c).attr("class")+'[name="order[]"]').val()}).each(function(){var e=a(this).attr("class"),f=d[b.variable_vault.find("input."+e+'[name="type[]"]').val()],g={};a.each(f.variables,function(a,c){g[c]=b.variable_vault.find("input."+e+'[name="'+c+'[]"]').val()}),a.isFunction(b.beforeDisplay)&&b.beforeDisplay(f,g);var h="";b.depth&&(h=" depth_"+b.variable_vault.find("input."+e+'[name="depth[]"]').val());var i='             <li class="form_field '+e+h+'">                '+f.display(g);b.gear_image&&(i+='               <a class="listable_gear '+e+'" href="#"><img src="'+b.gear_image+'" alt="show icons" /></a>'),i+='               <ul class="listable_item_buttons">',b.depth&&(i+='                  <li>                      <a class="field_depth shallower '+e+'" href="#"><img src="'+b.shallower_image+'" alt="make field shallower" /></a>                  </li>                  <li>                      <a class="field_depth deeper '+e+'" href="#"><img src="'+b.deeper_image+'" alt="make field deeper" /></a>                  </li>'),b.edit&&(i+='                  <li>                   <a class="edit_field '+e+'" href="#"><img src="'+b.edit_image+'" alt="edit field" /></a>                  </li>'),b.delete&&(i+='                  <li>                      <a class="delete_field '+e+'" href="#"><img src="'+b.delete_image+'" alt="delete field" /></a>                  </li>'),i+="               </ul>             </li>",b.field_dividers_enabled&&(i+='             <li class="field_divider '+e+'">           <img src="'+b.add_image+'" alt="add field" />             </li>'),c.current_divider.length?c.current_divider.after(i):c.element.prepend(i)}),b.initial_add&&!b.add_after&&(c.element.append('          <li class="field_divider divide_0">           <img src="'+b.add_image+'" alt="add field" />          </li>'),c.current_divider=c.element.find(".field_divider").filter(":first")),e&&(c.current_divider=temp_current_divder),a.fn.listable.counter++,this},transfer:function(b,c){var d=this.options;return field_class=c.item.attr("class").replace(/form_field /,"").replace(/ depth_\d/,"").replace(/ ui-sortable-helper/,""),a(".field_divider.place_holder").removeClass("place_holder").addClass(field_class),a(c.sender).listable("option","variable_vault").find('input[type="hidden"].'+field_class).appendTo(d.variable_vault),this},update_order:function(){var b=this.options,c=this;return c.element.find(".form_field").each(function(c){a(b.variable_vault).find("input."+a(this).attr("class").replace(/form_field /,"").replace(/ depth_\d/,"")+'[name="order[]"]').val(c)}),this}})}(jQuery,window,document);